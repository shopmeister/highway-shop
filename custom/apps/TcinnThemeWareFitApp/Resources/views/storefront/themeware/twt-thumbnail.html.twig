{# ThemeWareÂ® thubmnails for custom column layouts #}
{#
    @Storefront/storefront/themeware/twt-thumbnail.html.twig

    Note: 'sw_thumbnail' can't handle our custom viewports so we need to add our custom thumbnail generation (based on the 'thumbnail.html.twig')...
#}

{% block twt_thumbnail_utility %}
    {% set load = true %}

    {# By default no original image will be loaded as soon as thumbnails are available. #}
    {# When set to true the original image will be loaded when the viewport is greater than the largest available thumbnail. #}
    {% if loadOriginalImage is not defined %}
        {% set loadOriginalImage = false %}
    {% endif %}

    {# autoColumnSizes #}

    {#
        attributes (see above)
        - attributes.alt
        - attributes.title
        - attributes.loading
    #}

    {% if media.thumbnails|length > 0 %}
        {# ThemeWare: Handle our 5 column layouts #}
        {% if columnsLg == '2-4' %}
            {% set columnsLg = 2.4 %}
        {% endif %}

        {% if columnsXl == '2-4' %}
            {% set columnsXl = 2.4 %}
        {% endif %}

        {# ThemeWare: Set image size for every viewport #}
        {% set sizes = {
            xs: ((theme_config('breakpoint.sm') - 1) / (12 / columnsXs))|round(0, 'ceil') ~'px',
            sm: ((theme_config('breakpoint.md') - 1) / (12 / columnsSm))|round(0, 'ceil') ~'px',
            md: ((theme_config('breakpoint.lg') - 1) / (12 / columnsMd))|round(0, 'ceil') ~'px',
            lg: ((theme_config('breakpoint.xl') - 1) / (12 / columnsLg))|round(0, 'ceil') ~'px',
            xl: ((1440 - 1) / (12 / columnsXl))|round(0, 'ceil') ~'px',
            xxl: ((1600 - 1) / (12 / columnsXl))|round(0, 'ceil') ~'px'
        } %}

        {# set image size for largest viewport depending on the cms block sizing mode (boxed or full-width) #}
        {#
        {% if layout == 'full-width' %}
            {% set container = 100 %}
            {% set sizes = sizes|merge({ xl: (container / columns)|round(0, 'ceil') ~'vw'}) %}
        {% else %}
            {% set container = 1360 %}
            {% set sizes = sizes|merge({ xl: (container / columns)|round(0, 'ceil') ~'px'}) %}
        {% endif %}
        #}

        {% set thumbnails = media.thumbnails|sort|reverse %}

        {# Generate 'srcset' with all available thumbnails #}
        {% set srcsetValue %}{% apply spaceless %}
            {% if loadOriginalImage %}{{ media|sw_encode_media_url }} {{ thumbnails|first.width + 1 }}w, {% endif %}{% for thumbnail in thumbnails %}{{ thumbnail.url|sw_encode_url }} {{ thumbnail.width }}w{% if not loop.last %}, {% endif %}{% endfor %}
        {% endapply %}{% endset %}

        {# Generate sizes #}
        {% set sizesValue %}{% apply spaceless %}
            {% set sizeFallback = 100 %}

            {# set largest size depending on column count of cms block #}
            {#
            {% if autoColumnSizes and columns %}
                {% set sizeFallback = (sizeFallback / columns)|round(0, 'ceil') %}
            {% endif %}
            #}

            {% set breakpoint = {
                xs: theme_config('breakpoint.xs'),
                sm: theme_config('breakpoint.sm'),
                md: theme_config('breakpoint.md'),
                lg: theme_config('breakpoint.lg'),
                xl: theme_config('breakpoint.xl'),
                xxl: 1440
            } %}

            {% for key, value in breakpoint|reverse %}(min-width: {{ value }}px) {{ sizes[key] }}{% if not loop.last %}, {% endif %}{% endfor %}, {{ sizeFallback }}vw
        {% endapply %}{% endset %}
    {% endif %}

    {% block twt_thumbnail_utility_img %}
        <img {% if load %}src="{{ media|sw_encode_media_url }}" {% else %}data-src="{{ media|sw_encode_media_url }}" {% endif %}
            {% if media.thumbnails|length > 0 %}
                {% if load %}srcset="{{ srcsetValue }}" {% else %}data-srcset="{{ srcsetValue }}" {% endif %}
                {% if sizes['default'] %}
                 sizes="{{ sizes['default'] }}"
                {% elseif sizes|length > 0 %}
                 sizes="{{ sizesValue }}"
                {% endif %}
            {% endif %}
            {% for key, value in attributes %}{% if value != '' %} {{ key }}="{{ value }}"{% endif %}{% endfor %}
        />
    {% endblock %}
{% endblock %}